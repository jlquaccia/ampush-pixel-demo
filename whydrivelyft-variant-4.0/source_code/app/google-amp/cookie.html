<!DOCTYPE html>
<html>
    <body>
    <script type="text/javascript">
	      !function(){
          var t=document.createElement('script');t.setAttribute('type','text/javascript');
          t.setAttribute('src',"//files.ampush.io/js/tracker2.1.js?"+(new Date).valueOf());
          'undefined'!=typeof t&&document.getElementsByTagName('head')[0].appendChild(t);
          t.onload=function(){ampt.init('lyft', 'ce4c0c2b8-3c40-4963-9164-198a13f7689e')}
        }();

        var ref = document.referrer.split('?')[1] || '';
        var currentVariant = document.referrer.split('/').splice(3).join('/').split('?')[0].split('.')[0].split('/')[1].toString();

        var DEFAULT_PARAMETERS = ['utm_source=ampush', 'utm_campaign=PAID_DAX_SOC_US_ALL_ALL_092017_NEW_AMPUSH', 'adgroup=ALL_ALL_ALL_SFO_AMP_ALL_21-65', 'ad=AMP_NA_NA_Content_SO-500', 'utm_content=amp_kw4wV411o4At7yT2kBbqDzxE3WsHykURueS_9skOZ7o', 'utm_term=DR', 'code=AMP500FB', 'utm_aid=amp_kw4wV411o4At7yT2kBbqDzxE3WsHykURueS_9skOZ7o', 'cvosrc=aggregator.ampush.PAID_DAX_SOC_US_ALL_ALL_092017_NEW_AMPUSH', 'utm_variant=' + currentVariant];
				var UTM_PARAMS = ['utm_source', 'utm_campaign', 'adgroup', 'ad', 'utm_content', 'utm_term', 'code', 'utm_aid', 'cvosrc', 'utm_variant'];
				var VALID_UTM_SOURCE = ['ampush'];

				var ParamDefaultOrder = ['utm_source', 'utm_content','code','utm_campaign','UTM_TERM','utm_term','adgroup','ad', 'cvosrc', 'utm_variant'];

				var DefaultParams = {
				  UTM_SOURCE: 'ampush',
				  UTM_CONTENT: 'amp_kw4wV411o4At7yT2kBbqDzxE3WsHykURueS_9skOZ7o',
				  CODE: 'AMP500FB',
				  UTM_CAMPAIGN: 'PAID_DAX_SOC_US_ALL_ALL_092017_NEW_AMPUSH',
				  UTM_TERM: 'DR',
				  UTM_AID: 'amp_kw4wV411o4At7yT2kBbqDzxE3WsHykURueS_9skOZ7o',
				  ADGROUP: 'ALL_ALL_ALL_ALL_AMP_ALL_21-65',
				  AD: 'AMP_NA_NA_Content_SO-500',
				  CVOSRC: 'aggregator.ampush.',
				  UTM_VARIANT: currentVariant
				};

				var queryString;

				function utmTracker() {
				  if ((location.pathname.indexOf('index.html') == -1) && (location.pathname.indexOf('index-') == -1)) { //if page is Something other than index.html or index personal pages change to content
				    DefaultParams.UTM_TERM = 'content';
				    DEFAULT_PARAMETERS = ['utm_source=ampush', 'utm_campaign=PAID_DAX_SOC_US_ALL_ALL_092017_NEW_AMPUSH', 'adgroup=ALL_ALL_ALL_SFO_AMP_ALL_21-65', 'ad=AMP_NA_NA_Content_SO-500', 'utm_content=amp_kw4wV411o4At7yT2kBbqDzxE3WsHykURueS_9skOZ7o', 'utm_term=content', 'code=AMP500FB', 'utm_aid=amp_kw4wV411o4At7yT2kBbqDzxE3WsHykURueS_9skOZ7o', 'cvosrc=aggregator.ampush.PAID_DAX_SOC_US_ALL_ALL_092017_NEW_AMPUSH', 'utm_variant=' + currentVariant];
				  }

				  function setQueryStringParamsOnRefresh() {
				    // setting promo code to code input field if promo exists.
				    queryString = ref.replace(/%/g, "");
				    var pairs = queryString.split('&');
				    var result = {};

				    pairs.forEach(function (pair) {
				      pair = pair.split('=');
				      result[pair[0]] = decodeURIComponent(pair[1] || '');
				    });

				    // Checks if has URL parameters.
				    if (result.code) {
				      switch (result.code) {
				        case 'AMP200FB':
				        case 'AMP200G':
				        case 'AMP350FB':
				        case 'AMP350G':
				        case 'AMP500G':
				        case 'AMP500FB':
				          document.cookie = 'code=' + result.code + ";domain=.whydrivelyft.com;path=/";
				          break;
				        default:
				          document.cookie = 'code=' + DefaultParams.CODE + ";domain=.whydrivelyft.com;path=/";
				      }
				    } else if (getCookieValue('code')) {
				      // set code param based on first page visit
				      let cookieValue = getCookieValue('code');
				      setCookie('code=' + cookieValue, false);
				    } else {
				      document.cookie = 'code=' + DefaultParams.CODE + ";domain=.whydrivelyft.com;path=/";
				    }

				    // set utm_campaign & cvosrc param based on first page visit
				    if (result.utm_campaign) {
				      setCookie('utm_campaign=' + result.utm_campaign, false);
				      setCookie('cvosrc=' + DefaultParams.CVOSRC + result.utm_campaign, false);
				    } else {
				      let cookieValue = getCookieValue('utm_campaign');
				      if (!cookieValue) {
				        cookieValue = DefaultParams.UTM_CAMPAIGN;
				      }
				      setCookie('utm_campaign=' + cookieValue, false);
				    }

				    // set cvosrc param based on first page visit
				    if (result.cvosrc) {
				      if(result.cvosrc = DefaultParams.CVOSRC + result.utm_campaign) {
				        setCookie('cvosrc=' + result.cvosrc, false);
				      } else {
				        setCookie('cvosrc=' + DefaultParams.CVOSRC + result.utm_campaign, false);
				      }
				    } else {
				      let cookieValue = getCookieValue('cvosrc');
				      if (!cookieValue) {
				        cookieValue = DefaultParams.CVOSRC + DefaultParams.UTM_CAMPAIGN;
				      }
				      setCookie('cvosrc=' + cookieValue, false);
				    }

				    // set adgroup param based on first page visit
				    if (result.adgroup) {
				      setCookie('adgroup=' + result.adgroup, false);
				    } else {
				      let cookieValue = getCookieValue('adgroup');
				      if (!cookieValue) {
				        cookieValue = DefaultParams.ADGROUP;
				      }
				      setCookie('adgroup=' + cookieValue, false);
				    }

				    // set ad param based on first page visit
				    if (result.ad) {
				      setCookie('ad=' + result.ad, false);
				    } else {
				      let cookieValue = getCookieValue('ad');
				      if (!cookieValue) {
				        cookieValue = DefaultParams.AD;
				      }
				      setCookie('ad=' + cookieValue, false);
				    }

				    //if value of utm_term is content dont revert to DR, keep it same.
				    let utm_term = getCookieValue('utm_term');
				    if (utm_term != 'content') {
				      setCookie('utm_term=' + DefaultParams.UTM_TERM, false);
				    }

				    //if user is directly coming to index page with content as utm_term change it to content.
				    if(result.utm_term && result.utm_term=='content'){
				      setCookie('utm_term=' + 'content', false);
				    }

				    // set source param based on first page visit
				    if (result.utm_source !== DefaultParams.UTM_SOURCE && result.utm_source !== undefined) {
				      setCookie('utm_source=ampush', false);
				    } else {
				      let cookieValue = getCookieValue('utm_source');
				      if (!cookieValue) {
				        cookieValue = DefaultParams.UTM_SOURCE;
				      }
				      setCookie('utm_source=' + cookieValue, false);
				    }

				    // set utm_aid param based on first page visit
				    if (result.utm_aid) {
				      setCookie('utm_aid=' + result.utm_aid, false);
				    } else {
				      let cookieValue = getCookieValue('utm_aid');
				      if (!cookieValue) {
				        cookieValue = DefaultParams.UTM_AID;
				      }
				      setCookie('utm_aid=' + cookieValue, false);
				    }

				    // set utm_content param based on first page visit
				    if (result.utm_content) {
				      setCookie('utm_content=' + result.utm_content, false);
				    } else {
				      let cookieValue = getCookieValue('utm_content');
				      if (!cookieValue) {
				        cookieValue = DefaultParams.UTM_CONTENT;
				      }
				      setCookie('utm_content=' + cookieValue, false);
				    }

				    // update utm_variant param on each page visit
				    setCookie('utm_variant=' + currentVariant, false);
				  }

				  setQueryStringParamsOnRefresh();

				  if (queryString === '') {
				    if (hasValidCookie()) {
				      getValuesFromCookies();
				    } else {
				      setDefaultParams();
				      queryString = getValuesFromCookies();
				    }
				    checkAmptuid(false);
				    validateUTMContentAndSetCookies();
				  } else {
				    hasValidUTMSource();
				    checkAmptuid(true);
				  }
				}

				utmTracker();

				// ==============================================================================================================================
				// helper functions
				// ==============================================================================================================================

				function checkAmptuid(setcookie) {
				  if (!getCookieValue('amptuid')) {
				    setTimeout(function () {
				      checkAmptuid(setcookie);
				    }, 1000); // Try to submit form after timeout
				  } else {
				    if (setcookie) {
				      validateUTMContentAndSetCookies();
				      setParamsToLinks();
				      setCookie(queryString.split('&'), true);
				    } else {
				      setDefaultParameters();
				      validateUTMContentAndSetCookies();
				    }
				  }
				}

				function validateUTMContentAndSetCookies() {
				  var utm_content_val = searchQueryString(UTM_PARAMS[4]) || getCookieValue('utm_content');
				  updateCodeValue();

				  if (utm_content_val && (utm_content_val.split('-')[0] === getCookieValue('amptuid') || utm_content_val.split('-')[0] === getCookieValue('amptuid').split('-')[0])) { /* If Amptuid is already appended to utm_content*/
				    setDefaultParameters();
				    setParamsToLinks();
				  }
				  else if (!/^amp_/i.test( utm_content_val)) { /* If UTM_content is not encrypted*/
				    if (utm_content_val != '') {
				      encodeUTMParameter(utm_content_val, encodeUTMParameterCallback);
				    }
				  } else { /* If UTM_content is encrypted just concatenate with amptuid*/
				    setUTMContent(utm_content_val, setUTMContentCallback);
				  }
				}
				function encodeUTMParameterCallback() {
				  setDefaultParameters();
				  setParamsToLinks();
				}
				function setUTMContentCallback(utm_content_val) {
				  document.cookie = 'utm_aid=' + utm_content_val + ";domain=.whydrivelyft.com;path=/";
				  setDefaultParameters();
				  setParamsToLinks();
				}
				function setUTMContent(utm_content_val, callbackFunction) {
				  var value = getCookieValue('amptuid') + "-" + utm_content_val;
				  setCookieValue('utm_content', value);
				  callbackFunction(utm_content_val);
				}
				function updateCodeValue() {
				  var code_val = searchQueryString('code');
				  if (code_val) {
				    setCookieValue('code', code_val);
				  }
				}

				function setDefaultParameters() {
				  var temp_string = getCookie().split("; ").filter(s => s != '');
				  //removing the amptuid & _uetsid from the query parameter, but not from cookies.
				  temp_string.forEach(function(string, idx) {
				    if(string.indexOf('amptuid') > -1) {
				      temp_string.splice(idx, 1);
				    }
				    if (string.indexOf('_uetsid') > -1) {
				      temp_string.splice(idx, 1);
				    }
				  });

				  queryString = temp_string.join("&");
				}

				function getCookieValue(utm_key) {
				  var cookieString = getCookie().split("; ");
				  for (var val = 0; val < cookieString.length; val++) {
				    var item = cookieString[val];
				    var query_key = item.split("=")[0];
				    var query_val = item.split("=")[1];
				    if (utm_key == query_key) {
				      return query_val
				    }
				  }
				}

				function setCookieValue(utm_key, utm_value) {
				  var cookieString = getCookie().split(";");
				  var newCookieString = "";
				  for (var val = 0; val < cookieString.length; val++) {
				    var item = cookieString[val];
				    var cookie = item.split("=");
				    var query_key = cookie[0];

				    if (utm_key.trim() == query_key.trim()) {
				      cookie[1] = utm_value;
				      var cookie_value = cookie.join("=");
				      newCookieString = newCookieString + "; " + cookie_value;
				    } else {
				      newCookieString = newCookieString + "; " + item;
				    }
				  }
				  setCookie(newCookieString.split("; "), true);
				}

				function hasValidUTMSource() {
				  var UTMKeys = queryString.split("&");
				  var validFlag = false;
				  for (var item in UTMKeys) {
				    var utm_pair = UTMKeys[item];
				    var utm_key = utm_pair.split("=")[0];
				    if (utm_key == 'utm_source') {
				      var utm_val = 'ampush'; //PERF-465 fix utm_source always be 'ampush'
				      if (VALID_UTM_SOURCE.indexOf(utm_val)) {
				        validFlag = true;
				        setCookieValue('utm_source', utm_val);
				        document.cookie = 'utm_source=' + utm_val + ";domain=.whydrivelyft.com;path=/";
				        break;
				      }
				    }
				  }

				  if (!validFlag) {
				    queryString = getCookie().split("; ").filter(s => s != '').join("&");
				  }
				}

				function searchQueryString(key) {
				  var splits = queryString.split('&');
				  for (var val = 0; val < splits.length; val++) {
				    var item = splits[val];
				    if (key == item.split("=")[0]) {
				      return item.split("=")[1]
				    }
				  }
				}


				function hasValidCookie() {
				  var doc_cookies = getCookie().split(";");
				  for (var cookie = 0; cookie < doc_cookies.length; cookie++) {
				    if ('utm_source' == doc_cookies[cookie].trim().split("=")[0]) {
				      return true;
				    }
				  }
				  return false;
				}

				function getValuesFromCookies() {
				  return getCookie().split("; ").filter(s => s != '').join("&");
				}

				function setDefaultParams() {
				  setCookie(DEFAULT_PARAMETERS, true);
				  return DEFAULT_PARAMETERS;
				}

				function setCookie(params, doExpires) {
				  if (doExpires) {
				    var date = new Date();
				    var expires;

				    date.setTime(date.getTime() + (365 * 24 * 60 * 60 * 1000));
				    expires = 'expires=' + date.toUTCString();
				    params.forEach(function (param) {
				      document.cookie = param + ";" + expires + ";domain=.whydrivelyft.com;path=/";
				    });
				  } else {
				    document.cookie = params + ";domain=.whydrivelyft.com;path=/";
				  }
				}

				function getCookie() {
				  return decodeURIComponent(document.cookie);
				}

				function encodeUTMParameter(utm_campaign_val, callbackFunction) {


				  var ampId;
				  var validValue = [];
				  var UTMParams = queryString.split("&");


				  var xhttp = new XMLHttpRequest();
				  xhttp.open('POST', 'https://ampid.ampush.io/translate?id=' + utm_campaign_val,
				    true);
				  xhttp.onload = function () {
				    if (this.status == 200) {
				      var campaignId = JSON.parse(xhttp.response).amp_id;
				      document.cookie = 'utm_aid=' + campaignId + ";domain=.whydrivelyft.com;path=/";
				      UTMParams.forEach(function (param) {
				        var value = param.split('=');
				        if (value[0] == UTM_PARAMS[4]) {
				          var amptuid_val = getCookieValue('amptuid');
				          value[1] = amptuid_val + "-" + campaignId;
				          value = value.join("=");
				          validValue.push(value);
				        } else if (value[0] == UTM_PARAMS[7]) {
				          value[1] = campaignId;
				          value = value.join("=");
				          validValue.push(value);
				        } else {
				          validValue.push(param)
				        }
				      });
				      setCookie(validValue, true);
				      callbackFunction(validValue);
				    } else {
				      // Something went wrong (404 etc.)
				      reject(new Error(this.statusText));
				    }
				  };
				  xhttp.send();
				}

				function setParamsToLinks() {
				  var validatedParams = queryString.split('&');
				  validatedParams = validatedParams.filter(s => s != '').join('&'); //to remove extra space getting added while saving in cookies in production
				  //validatedParams =  reorderQueryString(validatedParams); //get reorderd queryString before appending it

				  var pageUrl = "";
				  // if (location.href.indexOf('?') !== -1) {
				    pageUrl = location.href.split('?')[0] + '?' + validatedParams;
				  // } else {
				    // pageUrl = location.href;
				  // }

				  var anchorEls = document.querySelectorAll('.js-tracker');
				  for (var i = 0; i < anchorEls.length; i++) {
				    anchorEls[i].href = /\?$/.test(anchorEls[i].href) ? anchorEls[i].href +
				      validatedParams : anchorEls[i].href + '&' + validatedParams;
				  }
				  window.history.replaceState({ urlPath: pageUrl }, '', pageUrl);
				}

				/**
				 * Reorder for Query parameters, as mentioned order
				 * @param {*} validatedParams
				 */
				function reorderQueryString(validatedParams){
				  var tempArray = {};
				  for(var i = 0 ; i < validatedParams.length;i++){
				    var param = validatedParams[i].split('=');
				    tempArray[param[0]]  = param[1];
				  }
				  var newQueryString =  ParamDefaultOrder[0] + "=" + tempArray[ParamDefaultOrder[0]];
				  for (var i = 1; i < ParamDefaultOrder.length; i++) {
				    newQueryString = newQueryString +"&" + ParamDefaultOrder[i] + "=" + tempArray[ParamDefaultOrder[i]] ;
				  }
				  return newQueryString;
				}
    </script>
    </body>
</html>
